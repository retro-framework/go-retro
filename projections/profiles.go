package projections

import (
	"context"
	"encoding/json"
	"fmt"
	"html/template"
	"net/http"
	"time"

	"github.com/go-redis/redis"

	"github.com/retro-framework/go-retro/events"
	"github.com/retro-framework/go-retro/framework/depot"
	"github.com/retro-framework/go-retro/framework/retro"
)

type Profile struct {
	Name      string       `json:"name"`
	AvatarSrc template.URL `json:"avatarSrc"`

	Created time.Time `json:"created"`
	Updated time.Time `json:"updated"`

	Hash string    `json:"hash"`
	URN  retro.URN `json:"urn"`
}

type Profiles interface {
	Get(context.Context, retro.URN) (Profile, error)
}

func NewProfiles(c *redis.Client, evManifest retro.EventManifest, d retro.Depot) redisProfiles {
	return redisProfiles{c, evManifest, d}
}

type redisProfiles struct {
	client     *redis.Client
	evManifest retro.EventManifest
	d          retro.Depot
}

func (rp redisProfiles) Get(ctx context.Context, pn retro.URN) (Profile, error) {

	var name = rp.client.HGet(pn.String(), "name")
	if name.Err() != nil {
		return Profile{}, name.Err()
	}

	var avatar = rp.client.HGet(pn.String(), "avatar")
	if avatar.Err() != nil {
		return Profile{}, name.Err()
	}

	var avatarMime = rp.client.HGet(pn.String(), "avatar_mime")
	if avatarMime.Err() != nil {
		return Profile{}, name.Err()
	}

	avatarURL := template.URL("data:" + avatarMime.Val() + ";base64," + avatar.Val())

	return Profile{
		Name:      name.Val(),
		AvatarSrc: avatarURL,
		URN:       retro.URN("urn:" + pn.String()),
	}, nil
}

func (rp redisProfiles) Run(ctx context.Context) {

	var identities = rp.d.Watch(ctx, "identity/*")

	for {
		identityEvents, err := identities.Next(ctx)
		if err == depot.Done {
			continue
		}
		if err != nil {
			fmt.Println("err on pi", err)
			return
		}
		if identityEvents != nil {
			go func(evIter retro.EventIterator) {
				var profile = Profile{}
				for {
					var pEv, err = evIter.Next(ctx)
					if err == depot.Done {
						continue
					}
					if err != nil {
						fmt.Println("es-listings: err", err)
						return
					}
					if pEv != nil {

						if profile.Created.IsZero() {
							profile.Created = pEv.Time()
						}

						profile.Updated = pEv.Time()

						profile.Hash = pEv.CheckpointHash().String()

						ev, err := rp.evManifest.ForName(pEv.Name())
						if err != nil {
							fmt.Println("err looking up event", err)
							continue
						}

						err = json.Unmarshal(pEv.Bytes(), &ev)
						if err != nil {
							fmt.Println("err unmarshalling event", err)
							continue
						}

						rp.client.SAdd("profiles", pEv.PartitionName())

						switch tEv := ev.(type) {
						case *events.SetDisplayName:
							rp.client.HSet(string(pEv.PartitionName()), "name", tEv.Name)
						case *events.SetAvatar:
							rp.client.HSet(string(pEv.PartitionName()), "avatar", `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`)
							rp.client.HSet(string(pEv.PartitionName()), "avatar_mime", http.DetectContentType(tEv.ImgData))
						case *events.SetVisibility:
							if tEv.Radius == "public" {
								rp.client.SAdd("profiles-public", pEv.PartitionName())
							}
						default:
							// fmt.Printf("not sure what to do with %#v\n", tEv)
						}
					}
				}
			}(identityEvents)
		}
	}
}
